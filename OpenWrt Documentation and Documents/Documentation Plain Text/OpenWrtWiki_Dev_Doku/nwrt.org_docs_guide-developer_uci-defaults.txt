====== UCI defaults ======
//OpenWrt// relies on UCI, the //Unified Configuration Interface//, to configure its core services.
UCI defaults provides a way to preconfigure your images, using UCI.

To set some system defaults the first time the device boots, create a script in the directory ''/etc/uci-defaults''.

All scripts in that folder are automatically executed by ''/etc/init.d/boot'':
  * If they exit with code 0 they are deleted afterwards.
  * Scripts that exit with non-zero exit code are not deleted and will be re-executed at the next boot until they also successfully exit.

In a live router you can see the existing UCI defaults scripts in ''/rom/etc/uci-defaults'' , as ''/etc/uci-defaults'' itself is typically empty (after all scripts have been run successfully and have been deleted).

UCI defaults scripts can be created by packages or they can be inserted into the build manually as custom files.

===== Integrating custom settings =====
You can preload custom settings by adding batch scripts containing UCI commands into the ''/files/etc/uci-defaults'' directory.
The path is identical for the buildroot and the image generator.
The scripts will be run **after** the flashing process - in case of upgrading, that also includes appending the existing configuration to the JFFS2 partition (mounted as ''/overlay'').
Scripts should not be executable.
To ensure your scripts are not interfering with any other scripts, make sure they get executed last by giving them a high prefix (e.g. //xx_customizations//).
A basic script could look like this:

<code bash>
cat << EOF_cat > /etc/uci-defaults/xx_customizations
uci -q batch << EOF
add dhcp host
set dhcp.@host[-1].name='bellerophon'
set dhcp.@host[-1].ip='192.168.2.100'
set dhcp.@host[-1].mac='a1:b2:c3:d4:e5:f6'
commit dhcp
EOF
EOF_cat
</code>

Once the script has run successfully and exited cleanly (exit status 0), it will be removed from ''/etc/uci-defaults''.
You can still consult the original in ''/rom/etc/uci-defaults'' if needed.

===== Ensuring scripts donâ€™t overwrite custom settings: implementing checks =====
Scripts in ''/etc/uci-defaults'' will get executed at every first boot (i.e. after a clean install or an upgrade), possibly overwriting already existing values.
If this behaviour is undesired, we recommend you implement a test at the top of your script - e.g. probe for a custom setting your script would normally configure:

<code bash>
[ "$(uci -q get system.@system[0].zonename)" = "America/New York" ] && exit 0
</code>

This will make sure, when the key has the correct value set, that the script exits cleanly and gets removed from ''/etc/uci-defaults'' as explained above.

===== Example scripts =====

The following ''uci-defaults'' scripts can probably be used as inspiration:

  * the ''base-files'' package [[https://git.openwrt.org/?p=openwrt/openwrt.git;a=tree;f=package/base-files/files/etc/uci-defaults;hb=HEAD|has a few uci-defaults scripts]]
  * the [[https://github.com/freifunk-berlin/firmware|Freifunk Berlin firmware]] makes [[https://github.com/freifunk-berlin/firmware-packages/tree/master/defaults|heavy use of uci-defaults scripts]]
  * the [[https://wiki.freifunk-ulm.de|Freifunk Ulm]] community does all its configuration in a [[https://github.com/ffulm/firmware/blob/master/files/etc/uci-defaults/50_freifunk-setup|huge uci-defaults script]]