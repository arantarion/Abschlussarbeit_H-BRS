====== PPTP server ======
{{section>meta:infobox:howto_links#cli_skills&noheader&nofooter&noeditbutton}}

===== Introduction =====
  * This how-to describes the method for setting up [[wp>Point-to-Point_Tunneling_Protocol|PPTP]] server on OpenWrt.
  * Follow [[docs:guide-user:services:vpn:pptp:client|PPTP client]] to set up PPTP server and [[docs:guide-user:services:vpn:pptp:extras|PPTP extras]] for additional tuning.

===== Goals =====
{{section>docs:guide-user:services:vpn:wireguard:server#goals&noheader&nofooter&noeditbutton}}

===== Instructions =====
==== 1. Preparation ====
Set up [[docs:guide-user:services:ddns:client|DDNS client]] if required.
Install the packages and specify the VPN server configuration parameters.

<code bash>
# Install packages
opkg update
opkg install pptpd kmod-nf-nathelper-extra

# Configuration parameters
PPTP_USER="PPTP_USERNAME"
PPTP_PASS="PPTP_PASSWORD"
PPTP_POOL="192.168.7.128-254"
</code>

==== 2. Firewall ====
Enable conntrack helper to allow related GRE traffic.
Consider VPN network as private and assign VPN interface to LAN zone to minimize firewall setup.
Allow access to VPN server from WAN zone.

<code bash>
# Configure kernel parameters
cat << EOF >> /etc/sysctl.conf
net.netfilter.nf_conntrack_helper=1
EOF
/etc/init.d/sysctl restart

# Configure firewall
uci rename firewall.@zone[0]="lan"
uci rename firewall.@zone[1]="wan"
uci del_list firewall.lan.device="ppp+"
uci add_list firewall.lan.device="ppp+"
uci -q delete firewall.pptp
uci set firewall.pptp="rule"
uci set firewall.pptp.name="Allow-PPTP"
uci set firewall.pptp.src="wan"
uci set firewall.pptp.dest_port="1723"
uci set firewall.pptp.proto="tcp"
uci set firewall.pptp.target="ACCEPT"
uci commit firewall
/etc/init.d/firewall restart
</code>

==== 3. VPN service ====
Configure VPN service.

<code bash>
# Configure VPN service
while uci -q delete pptpd.@login[0]; do :; done
uci set pptpd.pptpd.enabled="1"
uci set pptpd.pptpd.logwtmp="0"
uci set pptpd.pptpd.localip="${PPTP_POOL%.*}.1"
uci set pptpd.pptpd.remoteip="${PPTP_POOL}"
uci set pptpd.login="login"
uci set pptpd.login.username="${PPTP_USER}"
uci set pptpd.login.password="${PPTP_PASS}"
uci commit pptpd
/etc/init.d/pptpd restart
</code>

===== Testing =====
{{section>docs:guide-user:services:vpn:wireguard:server#testing&noheader&nofooter&noeditbutton}}

===== Troubleshooting =====
Collect and analyze the following information.

<code bash>
# Restart services
/etc/init.d/log restart; /etc/init.d/pptpd restart; sleep 10

# Log and status
logread -e pptpd; netstat -l -n -p | grep -e pptpd

# Runtime configuration
pgrep -f -a pptpd
ip address show; ip route show table all
ip rule show; ip -6 rule show; iptables-save; ip6tables-save
sysctl net.netfilter.nf_conntrack_helper

# Persistent configuration
uci show network; uci show firewall; uci show pptpd
grep -v -e "^#" -e "^$" /etc/sysctl.conf
</code>
