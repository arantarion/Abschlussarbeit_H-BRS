====== DNS over HTTPS with Dnsmasq and https-dns-proxy ======
{{section>meta:infobox:howto_links#cli_skills&noheader&nofooter&noeditbutton}}

===== Introduction =====
  * This how-to describes the method for setting up [[wp>DNS_over_HTTPS|DNS over HTTPS]] on OpenWrt.
  * It relies on [[docs:guide-user:base-system:dhcp.dnsmasq|Dnsmasq]] and [[packages:pkgdata:https-dns-proxy|https-dns-proxy]] for masking DNS traffic as HTTPS traffic.
  * Follow [[docs:guide-user:firewall:fw3_configurations:intercept_dns|DNS hijacking]] to intercept DNS traffic or use [[docs:guide-user:services:vpn:start|VPN]] to protect all traffic.

===== Goals =====
{{section>docs:guide-user:services:dns:dnscrypt_dnsmasq_dnscrypt-proxy#goals&noheader&nofooter&noeditbutton}}

===== Instructions =====
Install the packages and DNS encryption should be configured automatically.

<code bash>
# Install packages
opkg update
opkg install dnsmasq https-dns-proxy
</code>

LAN clients should use Dnsmasq as a primary resolver.
Dnsmasq forwards DNS queries to https-dns-proxy which encrypts DNS traffic.

===== Testing =====
{{section>docs:guide-user:services:dns:dnscrypt_dnsmasq_dnscrypt-proxy#testing&noheader&nofooter&noeditbutton}}

===== Troubleshooting =====
Collect and analyze the following information.

<code bash>
# Restart services
/etc/init.d/log restart; /etc/init.d/dnsmasq restart; /etc/init.d/https-dns-proxy restart

# Log and status
logread -e dnsmasq; netstat -l -n -p | grep -e dnsmasq
logread -e https-dns; netstat -l -n -p | grep -e https-dns

# Runtime configuration
pgrep -f -a dnsmasq; pgrep -f -a https-dns

# Persistent configuration
uci show dhcp; uci show https-dns-proxy
</code>

===== Extras =====
==== Web interface ====
Install the necessary packages if you want to manage the settings using web interface.

<code bash>
# Install packages
opkg update
opkg install luci-app-https-dns-proxy
</code>

  * Navigate to **[[http://openwrt.lan/|LuCI]] -> Network -> DHCP and DNS** to configure Dnsmasq.
  * Navigate to **[[http://openwrt.lan/|LuCI]] -> Services -> HTTPS DNS Proxy** to configure https-dns-proxy.

==== DoH provider ====
https-dns-proxy is configured with Google DNS and Cloudflare DNS by default.
You can change it Google DNS or any other [[wp>Public_recursive_name_server|DoH provider]].
Make sure the provider supports DNSSEC validation if required.
Specify several servers to improve fault tolerance.

<code bash>
# Configure DoH provider
while uci -q delete https-dns-proxy.@https-dns-proxy[0]; do :; done
uci set https-dns-proxy.dns="https-dns-proxy"
uci set https-dns-proxy.dns.bootstrap_dns="8.8.8.8,8.8.4.4"
uci set https-dns-proxy.dns.resolver_url="https://dns.google/dns-query"
uci set https-dns-proxy.dns.listen_addr="127.0.0.1"
uci set https-dns-proxy.dns.listen_port="5053"
uci commit https-dns-proxy
/etc/init.d/https-dns-proxy restart
</code>
