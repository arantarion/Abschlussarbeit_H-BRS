====== Lighttpd webserver ======
LuCI is the main web administration utility for OpenWrt. **By default LuCI uses [[docs:guide-user:services:webserver:http.uhttpd|uHTTPd]]**. 

Lighttpd is a highly-configurable, lightweight web server. See [[wp>lighttpd]] and [[http://www.lighttpd.net/]]. There are many modules available for lighttpd that can be installed and configured.  For more information on the modules see [[http://redmine.lighttpd.net/projects/lighttpd/wiki/docs]]. This article explains how to get lighttpd working on OpenWrt.

  * Consult [[docs:guide-user:luci:luci.on.lighttpd]] to make lighttpd serve the LuCI web interface.

===== Requirements =====
Execute
<code>
opkg list lighttpd*
</code>
to see what packages are available.

===== Installation =====
[[docs:guide-user:additional-software:opkg]]

<code>
opkg update
opkg install lighttpd
</code>

===== Configuration =====
Edit ''/etc/lighttpd/lighttpd.conf''


==== Basic Configuration ====
To get a basic server running make the following changes to ''/etc/lighttpd/lighttpd.conf'':

__Server Root Directory__

<code>
server.document-root = "/www1/"
</code>

where www1 is the root directory of the web server.

__Enable Logging__

Uncomment (remove #) the following line so errors are written to the log:

<code>
server.errorlog = "/var/log/lighttpd/error.log"
</code>

__Set Server Port__

Uncomment the following line:

<code>
server.port = 8000
</code>

where 8000 is the port you want your webserver on.


==== Advanced Configuration ====

=== Configure as a full LAMP stack ===
  * [[docs:guide-user:services:webserver:lamp|Set up a LAMP stack on OpenWrt]]


===== Configuring Lighttpd and PHP5 =====
  - First, follow [[docs:guide-user:services:webserver:php]] to install a version of PHP
  - Second, follow [[docs:guide-user:services:webserver:lamp#lighttpd1]] to configure lighttpd
  - Third, to get PHP running with Lighttpd you need to install the package 'lighttpd-mod-cgi'

===== Start on boot =====
To enable/disable start on boot:\\
''/etc/init.d/lighttpd enable''  this simply creates a symlink: ''/etc/rc.d/S90umurmur -> /etc/init.d/umurmur''\\
''/etc/init.d/lighttpd disable'' this removes the symlink again\\

To start the server one time:
''/etc/init.d/lighttpd start''
To stop the server again:
''/etc/init.d/lighttpd stop''


===== Firewall =====
To allow users on the WAN to access the server, make sure to configure the firewall in ''[[docs:guide-user:firewall:start|/etc/config/firewall]]'' and port forwarding settings.

<code>
config redirect
        option src              wan
        option src_dport        80
        option dest             lan
        option dest_ip          192.168.1.1
        option dest_port        8000
        option proto            tcp

config rule
        option src              wan
        option dest_port        8000
        option target           ACCEPT
        option proto            tcp
</code>

Restart the firewall with the following command: ''/etc/init.d/firewall restart''

===== Administration =====
**Add virtual hosts via mod_simple_vhost**

The goal is to run only one server on port 80. At the same time, this server should distinguish between different websites or directories.
First, the Lighttpd server is configured as described.
It must be ensured that the server works on port 80 (or any other port).
In my example, the local domain suffix was specified with "h" (see dnsmasq configuration).

Now add the following entries to your file:  **/etc/config/dhcp
**
<code>
config domain
      option name 'luci'
      option ip '192.168.1.1'
 
config domain
      option name 'home'
      option ip '192.168.1.1'
</code>

Add Module "mod_simple_vhost" to your:  **/etc/lighttpd/lighttpd.conf**
''server.modules = ( "mod_simple_vhost", )''


Create virtual host Configuration:  **/etc/lighttpd/conf.d/IntraNet.conf**

<code>
$HTTP["host"] =~ "^luci.h(\:[0-9]*)?$" { 
    dir-listing.activate = "disable" 
    server.document-root = "/www/"
    $HTTP["url"] =~ "^/cgi-bin" {
        cgi.assign += ( "" => "" )
    }
}

$HTTP["host"] =~ "^home.h(\:[0-9]*)?$" { 
    dir-listing.activate = "enable" 
    server.document-root = "/www/Home/"	
    url.redirect = ( "^/config/" => "/www/status-403.html",
                    "^/data/" => "/www/status-403.html",
                  )
}
</code>

Restarted dnsmasq and lighttpd: ''/etc/init.d/dnsmasq restart; /etc/init.d/lighttpd restart;''

Via the address  luci.h  the configuration can now be called, and another website via  home.h  
The IntraNet.conf can be extended with more virtual host names.
Within virtual host you can configure host specific configurations.

You can also configure Internet Websites with this, like example.org or second.example.org

//Make sure that the browser cache is deleted, often a new presence did not work because there is still some old information in the cache.//

===== Troubleshooting =====
__Incorrect Event Handler__

If you get the following error:

<code>
(server.c.1105) fdevent_init failed
</code>

you might need to set the event handler explicitly for your system. Add the following line to the configuration file:

<code>
server.event-handler = "poll"
</code>

See [[http://redmine.lighttpd.net/projects/lighttpd/wiki/Server.event-handlerDetails]]

===== Notes =====
  * Note that lighttpd does not support ''.htaccess'' files as some web servers do to configure directory specific server settings. Instead, it uses a centrally configured system using ''lighttpd.conf'' to define all settings, using powerful matching functions. This still means that you have to manually set up directory settings. Especially for (opkg) packages that supply ''.htaccess'' files to define required settings. Allowing directory listings is one example that should be disabled or enabled as per the required security level.

