====== Recuperação de falha na atualização de firmware ======

<WRAP center round tip 80%>
**RECOMENDADO:** **siga os procedimentos detalhados em [[docs:guide-user:troubleshooting:failsafe_and_factory_reset | Modo contra falhas e redefinição de fábrica]] primeiro**\\
É isso que provavelmente o ajudará se você não conseguir mais acessar a interface OpenWrt após instalar pacotes, alterar a senha ou a configuração de rede.
</WRAP>

Alguns fornecedores de dispositivos fornecem funções de resgate internas na partição de inicialização ROM do flash do dispositivo que permanecem lá, mesmo após uma atualização de firmware do OpenWrt, para que uma atualização do OpenWrt não substitua essa função de resgate.

Essas funções de resgate podem ser usadas para recuperar uma falha na atualização do flash (não importa se o flash com falha foi do firmware do fornecedor ou do OpenWrt) ou para recuperar de um dispositivo inoperante, desde que o hardware do dispositivo e a função de resgate ainda estejam intactos. Essas partições de resgate consomem um pedacinho do flash, mas tornam um dispositivo praticamente ininterrupto.

Infelizmente, essas funções de resgate não estão disponíveis para todos os fornecedores, às vezes não para todos os modelos de um fornecedor, e o processo de resgate real é principalmente específico do fornecedor. Esta página destina-se a coletar os métodos de resgate conhecidos de diferentes fornecedores ou modelos de roteadores.

===== Verifique primeiro: procedimentos de recuperação de firmware específicos do dispositivo =====
Verifique a "página do dispositivo" do seu dispositivo (procure um link nas últimas colunas da Tabela de Hardware). A página do dispositivo pode descrever um método de resgate para o seu dispositivo específico.
  * [[pt-br:toh:start|Tabela de Hardware]]

Alguns dos métodos podem exigir a criação de um cabo serial RS232 personalizado ou habilidades de soldagem, enquanto a maioria dos dispositivos mais novos exige apenas um truque de software para fazer flash remoto do dispositivo a partir de um cliente de PC.
===== Procedimentos de recuperação de firmware genéricos do fabricante =====

Muitos dispositivos dos seguintes fabricantes oferecem suporte a procedimentos de recuperação, conforme listado aqui:

^  Fabricante   ^  Procedimento  ^  Links  ^
| ASUS          | Um cliente tipo o TFTP do fabricante pode ser instalado em um PC para o procedimento de resgate. | [[https://www.asus.com/support/faq/1000814/ |Documentação oficial de recuperação da ASUS]] |
| D-Link        | Vários dispositivos têm uma [[#rescue_firmware_partition|partição de firmware de resgate]] na sua ROM flash. | |
| Linksys       | Vários dispositivos mais antigos suportam um procedimento de recuperação TFTP remoto.\\  Vários dispositivos mais novos têm[[#dual_firmware_partition| 2 partições de firmware independentes.]] | - [[https://www.linksys.com/us/support-article?articleNum=137928|Documentação oficial de recuperação de Linksys TFTP]]\\ - Para firmware duplo Linksys, [[#dual_firmware_partition|ver abaixo]] |
| Mikrotik      | Procedimento de recuperação com um cliente do tipo TFTP como um utilitário do fabricante chamado 'netinstall' instalado em um PC. | [[https://wiki.mikrotik.com/wiki/Manual:Netinstall|Documentação oficial de recuperação Microtik]] |
| Netgear       | O cliente TFTP em um PC pode ser usado para resgatar o firmware. | [[https://kb.netgear.com/000059633/How-to-upload-firmware-to-a-NETGEAR-router-using-TFTP-client|Documentação oficial de recuperação do Netgear via cliente TFTP]] |
|:::| nmrpflash | https://github.com/jclehner/nmrpflash |
| TP-Link       | O cliente de TFTP em um PC pode ser usado para resgatar o firmware.\\ Vários dispositivos mais novos fornecem uma[[#rescue_firmware_partition| partição de resgate]]. | [[https://community.tp-link.com/en/home/forum/topic/81462?page=1|Documentação de recuperação via cliente TFTP do fórum do TP-Link]] |
| ::: | Página de Recuperação de firmware\\ Veja o link para modelos que suportam esse método. | [[https://www.tp-link.com/us/faq-1482.html]] | 
| Ubiquiti (UBNT) | O cliente de TFTP em um PC pode ser usado para resgatar o firmware. | [[https://help.ubnt.com/hc/en-us/search?utf8=%E2%9C%93&query=firmware+recovery&commit=Search|Site oficial da UBNT: pesquisa no site por 'firmware recovery']] |
| Xiaomi        | Vários dispositivos com porta USB suportam um este método [[#rescue_usb_stick|Pendriver de resgate]]. | |
| ZBT (ZBTLink) | Vários dispositivos suportam um [[#rescue_firmware_partition|partição de resgate]].\\ Em alguns dispositivos, o cliente de TFTP em um PC pode ser usado para resgatar o firmware. | |
===== Recuperação para dispositivos baseados em imagem de disco (por exemplo: SD-cards) =====
Exemplos: Diferentes PI's do Raspberry, dispositivos de PC).

Os dispositivos OpenWrt que usam um image.gz ou sdcard.img.gz instalado na unidade não são um problema para recuperar. O sistema operacional OpenWrt não é aplicado à ROM flash, mas instalado em uma unidade removível, por exemplo um cartão SD. Para recuperação, monte a unidade removível em um PC em funcionamento e aplique novamente a imagem OpenWrt na unidade removível, de acordo com as instruções específicas do dispositivo.

===== Modo de recuperação via TFTP =====

Em vários desses procedimentos de recuperação, você precisará de um servidor TFTP em funcionamento no seu PC; veja como instalá-lo e configurá-lo no artigo [[pt-br:docs:guide-user:Troubleshooting:tftpserver | Configure um servidor TFTP]].

===== Recuperar via Pen-driver =====
Suportado por alguns dispositivos Xiaomi

processo para [[http://en.miui.com/thread-157895-1-1.html|Xiaomi Mi]]:
  - Faça o download do firmware e armazene-o como ''miwifi.bin'' em um pen-driver (deve ser FAT ou FAT32)
  - Conecte o pen driver na porta USB do dispositivo
  - Deslique o roteador
  - Pressione e segure o botão Reset e ligue o roteador
  - Solte o botão de Reset, quando o LED laranja de status começar a piscar
  - A atualização termina quando o LED fica azul

===== Partição de resgate de firmware =====
Compatível com vários dispositivos, pelo menos dos seguintes fornecedores: D-Link, TP-Link, ZBTLink

Essa função é baseada em código extra na partição de inicialização na ROM flash e ainda está disponível no dispositivo, mesmo após o dispositivo ter sido atualizado para o OpenWrt. Nenhuma ferramenta adicional é necessária para acionar esta função de resgate.

Procedimento, para inicializar na partição de recuperação:
  - Desligue o dispositivo (ou puxe o cabo de alimentação).
  - Conecte um cliente ao dispositivo via Ethernet para LAN1
  - Ative a função de resgate pressionando e segurando o botão de reinicialização do dispositivo e, em seguida, ligue o dispositivo (ou conecte o cabo de alimentação).
  - Você pode soltar o botão de redefinição após alguns segundos.
  - O dispositivo leva de 15 a 20 segundos para inicializar um servidor de mini-web, que fornece apenas uma única função: ele pode carregar um arquivo de firmware e possui um botão para acionar o processo de flash. O servidor da web geralmente estará disponível em qualquer um (em caso de dúvida, tente ambos)
    - http://192.168.0.1 (TP-Link e dispositivos D-Link mais recentes)
    - http://192.168.1.1 (ZBT-Link e dispositivos D-Link mais antigos)
    - Nota: Você precisa definir o seu cliente de PC para um endereço IP fixo de antemão, pois o DHCP não é suportado neste modo de recuperação. Portanto, dependendo do seu dispositivo, você precisa definir o cliente do PC para um endereço IP correspondente:
    - um IP de intervalo 192.168.0.x, por exemplo 192.168.0.2 / 255.255.255.0
    - um IP do intervalo 192.168.1.x, por exemplo 192.168.1.2 / 255.255.255.0

Notas:
  * A função de resgate não fornece acesso à Internet, Wi-Fi ou DHCP.
  * O firmware do OpenWrt pode ser atualizado diretamente usando esta função de recuperação ao usar um arquivo de firmware do OpenWrt ...** factory.bin**. Não é necessário primeiro atualizar o firmware oficial da D-Link.
  * A documentação oficial da D-Link deste procedimento é rara, uma [[ftp://ftp.dlink.de/dir/dir-600/documentation/DIR-600_revb12_howto_de_FirmwareRecovery.pdf|documentação alemã D-Link para o DIR-600]] existe (com o mesmo procedimento também para outros dispositivos D-Link, se o dispositivo suportar recuperação). Documentação não oficial: [[toh:d-link:dir-505#web_interface|OpenWrt Wiki para DIR-505]] e  [[http://forums.dlink.com/index.php?topic=44909.msg162511#msg162511|Forum D-Link]].
  * Notas não oficiais de [[https://fccid.io/2AH9TW826/Users-Manual/User-Manual-2994820|Recuperação do ZBTLink]],
  * Oficial [[http://www.tp-link.de/faq-1482.html|Notas da partição de resgate TP-Link]]

===== Partição dupla do firmware =====
Suportado por dispositivos Linksys mais recentes

A maioria dos roteadores mais recentes (principalmente aqueles com quantidade razoável de ROM flash) possui 2 partições de firmware independentes. Uma estratégia de uso pode ser instalar o OpenWrt apenas em uma das 2 partições e deixar o firmware do fornecedor na outra partição. Nenhuma ferramenta adicional é necessária para alternar entre as duas partições.

Procedimento, para alternar manualmente entre as duas partições de firmware: 
  - Desligue o roteador.
  - Ligue o roteador 3x por 2 segundos e depois desligue-o novamente.
  - Ligue o roteador, agora o roteador deve inicializar na partição alternativa.

Quando inicializado com êxito em qualquer uma das duas partições, uma atualização do firmware será gravada na outra partição secundária. A partição que está inicializada no momento permanece intocada.
