====== OpenWrt on VMware HowTo ======

This article describes how to use OpenWrt as a virtual machine with VMware virtualization.

===== Tested with =====

  * Barrier Breaker 14.07 in combination with VMware ESXi 5.5 Update 2 Build 2068190
  * Chaos Calmer 15.05.1 with VMware Fusion and vSphere ESXi 6.0
  * 19.07.0-rc2 in combination with VMware ESXi 6.7.0 Update 2 Build 13981272

==== Things you need ====

  * [[https://downloads.openwrt.org/barrier_breaker/14.07/x86/generic/openwrt-x86-generic-combined-ext4.img.gz]] or
  * [[https://downloads.openwrt.org/chaos_calmer/15.05/x86/64/openwrt-15.05-x86-64-combined-ext4.img.gz]]
  * Linux machine with qemu-utils & gunzip installed or OS X machine with qemu installed (via [[http://brew.sh|Homebrew]])
  * Hypervisor with VMware ESXi, Fusion, Player, or Workstation installed 

First of all, you need to download the image from list above on your machine. After that you extract & convert it to a vmdk image:

<code>
gunzip openwrt-x86-generic-combined-ext4.img.gz
qemu-img convert -f raw -O vmdk openwrt-x86-generic-combined-ext4.img openwrt-x86-generic-combined-ext4.vmdk
</code>

or

<code>
yum -y install qemu-img
wget https://downloads.openwrt.org/chaos_calmer/15.05/x86/64/openwrt-15.05-x86-64-combined-ext4.img.gz
gunzip openwrt-15.05-x86-64-combined-ext4.img.gz
qemu-img convert -f raw -O vmdk openwrt-15.05-x86-64-combined-ext4.img openwrt-15.05-x86-64-combined-ext4.vmdk
</code>

or on a Mac

<code>
brew install qemu
qemu-img convert -f raw -O vmdk ~/Downloads/openwrt-15.05-x86-64-combined-ext4.img openwrt-15.05-x86-64-combined-ext4.vmdk
</code>

after that, just create a new VM in Fusion, Workstation, or ESXi with "Linux\Other Linux 32-bit" with LSI BUS Logic & add the vmdk there. Use Intel PRO/1000 Network adapters. This may require editing the .vmx file to include following definition:
//(On Workstation 10, the e1000 gave a corrupted vmx file. Using V6 machine type did work. So it seems somewhere between V6.5 and V10 VMware dropped support for the e1000 driver and/or the virtualDev keyword.)//

<code>
ethernet0.virtualDev = "e1000"
</code>

On Fusion I had to use the IDE drive controller type.

===== Quick Start =====

Follow these steps to get an Up to Date VM with the latest code running on ESX in 15 minutes:
  - you can download an OVA image from the following location: [[https://www.dropbox.com/s/ao805tl33mqe0an/openwrt15cc.ova|https://www.dropbox.com/s/ao805tl33mqe0an/openwrt15cc.ova]]\\ This image was made by Iben in September 2015 based on a July build of CHAOS CALMER 15.05 trunk r46767
  - Import the OVA to VMware ESXi (tested with latest version 6 in July 2016)\\ The base image only has 1 virtual NIC setup with DHCP
  - Power on the VM - observe the MAC Address - find that on you DHCP server
  - Confirm the OpenWrt VM's IP address by opening the console 
  - Press enter to get a prompt
  - Type ''ifconfig | more'' to see the DHCP assigned IP address for the Bridge assigned to the NIC
  - If you don't have a DHCP server on your network you can set the IP Address manually: ''vi /etc/config/network''\\ The whole goal here is to get the OpenWrt VM on the network so you can hit the LuCI Web User Interface with a web browser. This way we can update the base image.
  - Once you've logged in to the LuCI web interface set a root password so you can ssh in
  - With the Web UI navigate to the System/Flash Operations page and find this text: //Flash new firmware image - Upload a sysupgrade-compatible image here to replace the running firmware//. Check "Keep settings" to retain the current configuration (requires an OpenWrt compatible firmware image).
  - On your admin system with the web browser download the latest file to prepare for the flash upgrade of OpenWrt: [[https://downloads.openwrt.org/chaos_calmer/15.05.1/x86/generic/openwrt-15.05.1-x86-generic-combined-ext4.img.gz]]  <-- this was the most current available from [[https://downloads.openwrt.org/]] dated 16 March 2016 (last checked 11 Sept 2016)
  - Then upload that to your running OpenWrt system and click "Flash Image..."
  - Reboot and login again.
  - Now you can add the second NIC to use the OpenWrt VM as a WAN router. I set mine up with both DHCP and Static IP addresses for the WAN - and the LAN interface was configured as a DHCP server.
  - To prepare for testing: install iperf3 and nmap from the System/Software page of the Web UI.
  - See the testing section below for details...
  - That's pretty much it. I'm very happy with this new setup.  I was also looking at M0n0wall (monowall), and pfsense to run as VMs but OpenWrt has a lot more going for it as far as an Open Source eco-system and developer/vendor support.

==== Testing ====

  - Start the server on OpenWrt: ''iperf3 -s'' 
  - Download the iperf3 binaries for various Operating Systems from here: [[https://iperf.fr/iperf-download.php]]
  - Then install and run the client on other machines on your network.
  - ''iperf3 -c <ip-address-of-the-server>''

Here are some results from my system:
    * 2012 MacBook with 802.11n on 5GHz --> 284 Mbits/sec
    * 2011 MacMini with CentOS 7.1 --> 958 Mbits/sec
    * Ubuntu VM running on same old Dell T110 ESXi host and OpenWrt VM --> 4.14 Gbits/sec 

As you can see - the OpenWrt virtual machine running on VMware ESX is very capable of keeping up with your home internet router needs! And this is with only 1 virtual CPU and no tuning at all.

==== ToDo List ====

Here's a wish list of things we would like to accomplish with OpenWrt - consider this technical debt. 

(Is there a better place to make these requests?)

  - install open-vm-tools to enhance support on VMware hypervisors
  - use vmxnet3 paravirtualized network interface 
  - learn how to create fresh builds from scratch
  - install cloud-init capabilities to allow auto-configuration on OpenStack based clouds like OPNFV
  - create jenkins job as part of CI to download and convert the raw image to vmdk with each build
  - create jenkins job as part of CI to download and convert the raw image to qcow2 with each build
  - do these conversions for both stable and trunk
  - integrate OpenWrt into the CI Pipeline for other network testing projects like OPNFV

===== Disk Size Issues =====

Disk size and problems with veeam backup and enlarging the disk
Veeam backup and VMware will complain about the size of the virtual disk provided by the OpenWrt download
because the disk is not multiple of 1KB. (this means: no backups available, and could be crucial
in production environments)

VMware won't let you enlarge the disk in the normal way, so one simple way is:

  - make a snapshot of the vm, for possible rollback
  - move the original disk (from OpenWrt downloads) on ide 0:1
  - add a new disk, with a whole size, like 128 MB , on ide 0:0
  - use ''sysrescuecdiso''
  - start the vm with the iso
  - with dd copy the disc on ide 0:1 to ide 0:0 like ''dd if=/dev/sdb of=/dev/sda''
  - enter ''fdisk /dev/sda'' and write the partition table (without making changes, this helps sysrescuecd to see the partitions properly)
  - do ''fsck -f'' on the sda2 partition
  - with ''fdisk'' resize the sda2 partition to occupy all the space available (but still starting with the same sector of before, normally 9135)
  - use ''resize2fs /dev/sda2''
  - do ''fsck -f /dev/sda2''
  - restart the machine and boot with OpenWrt check that the system uses the new partition
  - stop the machine, delete the previous hd (with less than 128MB)
  - restart the machine and verify that everything is ok.


===== Community =====

Please use these images in your home and work labs and provide any feedback you might have.

Feel free to update this wiki page with your results.

There is some feedback that the newer images are not booting properly.  Has anyone else run into this issue?

<html>
<blockquote class="twitter-tweet" data-lang="en"><p lang="en" dir="ltr"><a href="https://twitter.com/iben">@iben</a> learn , well, your quickstart ova works great. Following the instructions in the paragraph above it by the letter doesn&#39;t. /shrug .</p>&mdash; Phoenixxl (@Phoenixxl) <a href="https://twitter.com/Phoenixxl/status/775043516070260740">September 11, 2016</a></blockquote>
<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
</html>


----

==== Example Issues seen during VMWare Installs ====

VMDK (1st method): e1000 interface is found/loads intermittently. 

Corresponds to Seg Fault errors in **kmodloader** when loading **libuclibc**. 

=== Build Summary ===


  * VMWare ESXi 6.1
  * 1 CPU
  * 512 MB Memory
  * Image Used for VMDK:  https://downloads.openwrt.org/chaos_calmer/15.05/x86/64/openwrt-15.05-x86-64-combined-ext4.img.gz
  * Extraneous devices (USB, etc) removed 
